<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chấm công Mini</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f5f7fa;
        }

        main.container {
            max-width: 500px;
            width: 100%;
            padding: 2rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .title-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        .title-main {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 0;
        }

        .title-sub {
            font-size: 1.2rem;
            color: #34495e;
            margin: 0.5rem 0 0 0;
        }

        #loginSection {
            background-color: white;
            padding: 20px;
            text-align: center;
            border-radius: 0.5rem;
            border: 1px solid #e1e4e8;
        }

        video {
            width: 100%;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #e1e4e8;
        }

        #status {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 500;
        }

        .hidden {
            display: none;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .info {
            background-color: #cce5ff;
            color: #004085;
        }

        .user-info {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <main class="container">
        <div class="title-container">
            <h1 class="title-main">CHẤM CÔNG</h1>
            <h2 class="title-sub">BỆNH VIỆN PHỤ SẢN - NHI ĐÀ NẴNG</h2>
        </div>

        <!-- Vùng Đăng nhập -->
        <div id="loginSection">
            <p>Vui lòng đăng nhập bằng Gmail</p>
            <button id="loginBtn">Đăng nhập</button>
        </div>

        <!-- Vùng Chấm công (ẩn ban đầu) -->
        <div id="checkInSection" class="hidden">A
            <div class="user-info">
                <p>Xin chào, <strong id="userEmail"></strong></p>
                <a href="#" id="logoutBtn">Đăng xuất</a>
            </div>

            <label for="employeeId">Mã nhân viên (CCCD)</label>
            <input type="text" id="employeeId" name="employeeId" placeholder="Nhập CCCD/Mã nhân viên của bạn" required>

            <video id="cameraFeed" autoplay playsinline></video>
            <canvas id="canvas" class="hidden"></canvas>

            <button id="checkInBtn" aria-busy="false">Chụp ảnh & Chấm công</button>
        </div>

        <div id="status" class="hidden"></div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- PHẦN CẤU HÌNH - BẠN CẦN THAY THẾ ---
        const SUPABASE_URL = 'https://kmrotnknwcsxobzgkgom.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imttcm90bmtud2NzeG9iemdrZ29tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyOTI5MDYsImV4cCI6MjA2OTg2ODkwNn0.oPHfJH2wdWX9S2gWbzCYVQlVobkztAr0UitSscXcofM';
        // -----------------------------------------

        let supabase;
        if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        const loginSection = document.getElementById('loginSection');
        const checkInSection = document.getElementById('checkInSection');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userEmailSpan = document.getElementById('userEmail');
        const video = document.getElementById('cameraFeed');
        const canvas = document.getElementById('canvas');
        const checkInBtn = document.getElementById('checkInBtn');
        const employeeIdInput = document.getElementById('employeeId');
        const statusDiv = document.getElementById('status');

        function showStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = type;
        }

        // Xử lý đăng nhập
        loginBtn.addEventListener('click', async () => {
            if (!supabase) {
                showStatus("Lỗi cấu hình Supabase.", 'error');
                return;
            }
            const {error} = await supabase.auth.signInWithOAuth({
                provider: 'google',
            });
            if (error) {
                showStatus(`Lỗi đăng nhập: ${error.message}`, 'error');
            }
        });

        // Xử lý đăng xuất
        logoutBtn.addEventListener('click', async () => {
            if (!supabase) return;
            const {error} = await supabase.auth.signOut();
            if (error) {
                showStatus(`Lỗi đăng xuất: ${error.message}`, 'error');
            } else {
                checkInSection.classList.add('hidden');
                loginSection.classList.remove('hidden');
            }
        });

        // Kiểm tra trạng thái đăng nhập khi tải trang
        async function checkLoginState() {
            if (!supabase) return;
            const {data: {session}} = await supabase.auth.getSession();
            if (session) {
                loginSection.classList.add('hidden');
                checkInSection.classList.remove('hidden');
                userEmailSpan.textContent = session.user.email;
                startCamera();
            } else {
                loginSection.classList.remove('hidden');
                checkInSection.classList.add('hidden');
            }
        }

        // Theo dõi sự thay đổi trạng thái đăng nhập
        if (supabase) {
            supabase.auth.onAuthStateChange((_event, session) => {
                checkLoginState();
            });
        }

        // --- Các hàm camera, GPS, chấm công (giữ nguyên như cũ) ---
        async function startCamera() { /* ... */}
        function getGPSLocation() { /* ... */}
        function captureAndCompressImage() { /* ... */}
        checkInBtn.addEventListener('click', async () => { /* ... */});

        // Dán lại nội dung các hàm này từ code demo trước
        async function startCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showStatus("Trình duyệt không hỗ trợ camera.", 'error');
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'user'}});
                video.srcObject = stream;
            } catch (err) {
                showStatus("Không thể truy cập camera. Vui lòng cấp quyền.", 'error');
            }
        }

        function getGPSLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    return reject(new Error("Trình duyệt không hỗ trợ GPS."));
                }
                navigator.geolocation.getCurrentPosition(
                    position => resolve({latitude: position.coords.latitude, longitude: position.coords.longitude}),
                    () => reject(new Error("Không thể lấy vị trí GPS."))
                );
            });
        }

        function captureAndCompressImage() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            return new Promise(resolve => {
                canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.5);
            });
        }

        checkInBtn.addEventListener('click', async () => {
            const employeeId = employeeIdInput.value.trim();
            if (!employeeId) {
                showStatus("Vui lòng nhập mã nhân viên.", 'error');
                return;
            }

            checkInBtn.setAttribute('aria-busy', 'true');
            checkInBtn.disabled = true;
            showStatus("Đang xử lý...", 'info');

            try {
                const [location, imageBlob] = await Promise.all([getGPSLocation(), captureAndCompressImage()]);
                const fileName = `${employeeId}_${Date.now()}.jpg`;

                const {error: uploadError} = await supabase.storage.from('anh_cham_cong').upload(fileName, imageBlob);
                if (uploadError) throw uploadError;

                const {data: urlData} = supabase.storage.from('anh_cham_cong').getPublicUrl(fileName);

                const {data: {session}} = await supabase.auth.getSession();
                const userEmail = session ? session.user.email : 'unknown';

                const {error: insertError} = await supabase.from('cham_cong').insert({
                    ma_nhan_vien: employeeId,
                    thoi_gian: new Date().toISOString(),
                    vi_do: location.latitude,
                    kinh_do: location.longitude,
                    link_anh: urlData.publicUrl,
                    email_nhan_vien: userEmail
                });
                if (insertError) throw insertError;

                showStatus(`Chấm công thành công!`, 'success');
                employeeIdInput.value = '';

            } catch (error) {
                showStatus(`Lỗi: ${error.message}`, 'error');
            } finally {
                checkInBtn.setAttribute('aria-busy', 'false');
                checkInBtn.disabled = false;
            }
        });

    </script>
</body>

</html>